# backup-fault-tolerance

**Резервное копирование**

**Rsync** — программа, которая выполняет синхронизацию файлов и каталогов

**Преимущества rsync**
- Позволяет сохранять символические ссылки, жёсткие ссылки, владельцев и права файла, метаданные и время создания
- Не требует повышенных привилегий для запуска
- Сокращает объём передаваемой по сети информации, так как может передавать только изменённые файлы и даже части файлов

**Основные опции**

-a - Архивный режим, этот параметр определяет сразу комбинацию полезных опций -rlptgoD. Эти параметры позволяют максимально точно рекурсивно синхронизировать каталоги, передавать специальные и блочные устройства, сохранять символические ссылки, время модификации и права доступа

--delete - При использовании этой опции rsync удаляет посторонние файлы из места назначения, это удобно для полной зеркальной копии

--include / --exclude - Опции позволяют включать или исключать определённые файлы и каталоги из синхронизации

Алгоритм работы rsync
- Сравнивает время модификации и размер файла
- Разделяет файлы на фрагменты
- Если они одинаковые, синхронизация не нужна
- Это поведение можно переопределить, чтобы rsync считал контрольную сумму для каждого файла, даже если время и размер у них одинаковы, но это потребует больше времени
- Подсчитывает контрольные суммы с использованием хеш-функции
- Отправляет только изменившиеся части файла

Почему сейчас используют именно режим SSH, а не серверный вариант rsync. В некоторых руководствах предлагают настраивать rsync в серверном режиме (как постоянно запущенный сервис), но у работы по протоколу SSH есть преимущества:
- Надёжная авторизация на основе ключей
- Шифрование передаваемых данных
- Сжатие
- Нет необходимости открывать дополнительные порты на файерволе



**Отказоустойчивость в облаке**

У любого сервиса есть **SLA**. SLA — это набор метрик и их допустимых значений между пользователем сервиса и провайдером сервиса. Одна из метрик* SLA для любого сервиса — его доступность

**Отказоустойчивость** — способ увеличения доступности сервиса

**Когда нужна отказоустойчивость**

Когда недоступность сервиса ведёт к финансовым потерям:
- в связи с упущенной выручкой и прибылью
- потерей пользователей/клиентов
- негативной репутацией (пользователи ждут 100% uptime)
- нарушением требований регуляторов
- нарушением критических бизнес-процессов компании
Но отказоустойчивость — это дополнительные затраты на сервис, поэтому важно применять её тогда, когда это целесообразно

**Когда отказоустойчивость необязательна**

Бывают ситуации, когда отказоустойчивость может быть избыточной:
- среды разработки и тестирования
- задачи, у которых нет SLA по доступности, например батч-задачи
Важно во всех сервисах, где доступность приложения — часть SLA, договориться о метриках доступности, даже если высокая доступность не требуется

**Из чего состоит отказоустойчивость**
- Избыточность (redundancy)
- Мониторинг узлов
- Реакция на сбой (failover)
- Возвращение узла в кластер (failback)
Нужно понимать, из каких компонентов состоит сервис, чтобы сделать эти компоненты отказоустойчивыми

**Почему сервис может быть недоступен**
- Атака
- Проблемы из-за инфраструктуры
- Проблемы из-за настроек сервиса

**Как снизить риски сбоя сервиса**

**Атака**

DoS
- Анализируйте приложение на уязвимости. Примеры сканеров: Burp Suite, Acunetix, Nessus
- Можно заказать pentest от Лаборатории Касперского, Group-IB, BI.ZONE
- Используйте web application firewall: Imperva, F5, NGINX Plus, Wallarm, Cloudflare
DDoS
- Яндекс Облако, Qrator Labs, Cloudflare, Akamai
- Автомасштабирование: Instance Groups, Managed Kubernetes

**Сбой на стороне инфраструктуры**

Сбой сервера
- Балансировка нагрузки с использованием healthchecks
- Anti-affinity-правила — гарантия того, что копии сервиса запускаются
Сбой дата-центра
- Балансировка нагрузки на несколько дата-центров
- Disaster recovery

**Сбой из-за лимитов**

Сеть
- Используйте средства для уменьшения паразитной нагрузки
- Горизонтально масштабируйте нагрузку
Диски
- Читайте документацию
- Увеличивайте размер диска и число дисков
- Горизонтально масштабируйте нагрузку

**Сбой на стороне приложения**

ОС
- Мониторинг ОС (потребление RAM, CPU, свободного места)
- Обновление ОС и ядра
- Масштабирование места на диске

Баги
- Dev/stage-среды
- Юнит-тесты, интеграционные тесты
- Возможность сделать rollback
- Современные методики деплоя
- Учения
- Feature-флаги

**Перегрузка**

Реализовывайте сайзинг — приложение должно уметь обрабатывать нагрузку:
- при падении нескольких узлов
- при падении дата-центра

- Готовьтесь к возможной неравномерной балансировке
- Делайте мониторинг нагрузки3
- Делайте нагрузочное тестирование перед вводом в продакшн4
- Приложение должно уметь горизонтально масштабировать входящую нагрузку: автоматически или вручную

Аккуратно комбинируйте резервирование и автомасштабирование: алгоритмы автоскейлинга могут не успеть масштабировать нагрузку при высоких её всплесках

![back0](https://github.com/joos-mon-keep/backup-fault-tolerance/blob/main/backup0.png)

![back1](https://github.com/joos-mon-keep/backup-fault-tolerance/blob/main/backup1.png)
